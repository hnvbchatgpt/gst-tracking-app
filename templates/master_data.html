{% extends "base.html" %}

{% block title %}Master Data - GST Return Tracking System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="card-title">
                    <i class="fas fa-users"></i> Client Master Data
                </h4>
                <div>
                    <button class="btn btn-success" onclick="downloadTemplate()">
                        <i class="fas fa-download"></i> Download Template
                    </button>
                    <button class="btn btn-info" onclick="importClients()">
                        <i class="fas fa-upload"></i> Import Excel
                    </button>
                    <button class="btn btn-warning" onclick="exportClients()">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button class="btn btn-primary" onclick="showAddClientModal()">
                        <i class="fas fa-plus"></i> Add New Client
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="clientsTable">
                        <thead class="tbl-thead-background">
                            <tr>
                                <th style="max-width: 70px;">Client Code</th>
                                <th>Client Name</th>
                                <th>GSTIN</th>
                                <th>Taxpayer Type</th>
                                <th style="max-width: 110px;">Registration Date</th>
                                <th>Email</th>
                                <th>Mobile</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for client in clients %}
                            <tr>
                                <td>{{ client[0] }}</td>
                                <td style="white-space: nowrap;">{{ client[1] }}</td>
                                <td>{{ client[4] }}</td>
                                <td>
                                    <span class="badge bg-{{ 'primary' if client[5] == 'Monthly' else 'success' if client[5] == 'Quarterly' else 'warning' }}">
                                        {{ client[5] }}
                                    </span>
                                </td>
                                <td>{{ client[2].strftime('%d-%m-%Y') if client[2] else '' }}</td>
                                <td class="text-wrap text-break" style="max-width: 180px;">{{ client[10] }}</td>
                                <td>{{ client[11] }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editClient({{ client[0] }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteClient({{ client[0] }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Client Modal -->
<div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="clientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clientModalLabel">Add New Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="clientForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="clientName" class="form-label">Client Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="clientName" name="client_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="gstin" class="form-label">GSTIN <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="gstin" name="gstin" pattern="[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dateOfRegistration" class="form-label">Date of Registration <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="dateOfRegistration" name="date_of_registration" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="effectiveDateOfCancellation" class="form-label">Effective Date of Cancellation</label>
                                <input type="date" class="form-control" id="effectiveDateOfCancellation" name="effective_date_of_cancellation">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="taxpayerType" class="form-label">Taxpayer Type <span class="text-danger">*</span></label>
                                <select class="form-select" id="taxpayerType" name="taxpayer_type" required>
                                    <option value="">Select Taxpayer Type</option>
                                    {% for type in taxpayer_types %}
                                    <option value="{{ type }}">{{ type }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="clientEmailId" class="form-label">Client Email ID <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="clientEmailId" name="client_email_id" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="mobileNo" class="form-label">Mobile No <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="mobileNo" name="mobile_no" pattern="[0-9]{10}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="gstPortalUserId" class="form-label">GST Portal User ID <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="gstPortalUserId" name="gst_portal_userid" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="gstPortalPassword" class="form-label">GST Portal Password <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="gstPortalPassword" name="gst_portal_password" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ewayBillUserId" class="form-label">EWAY Bill User ID</label>
                                <input type="text" class="form-control" id="ewayBillUserId" name="eway_bill_userid">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ewayBillPassword" class="form-label">EWAY Bill Password</label>
                                <input type="password" class="form-control" id="ewayBillPassword" name="eway_bill_password">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="emailPassword" class="form-label">Email Password</label>
                                <input type="password" class="form-control" id="emailPassword" name="email_password">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Client</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import File Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">Import Clients from Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="importForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="importFile" class="form-label">Select Excel File</label>
                        <input type="file" class="form-control" id="importFile" accept=".xlsx,.xls" required>
                    </div>
                    <div class="alert alert-info">
                        <strong>Note:</strong> Please ensure your Excel file follows the template format. 
                        <a href="#" onclick="downloadTemplate()">Download template</a> if needed.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Import Clients</button>
                </div>
            </form>
        </div>
    </div>
</div>

<input type="hidden" id="editClientCode" value="">
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/excel_handler.js') }}"></script>
<script>
// Master Data JavaScript Functions
let editingClientCode = null;

function showAddClientModal() {
    document.getElementById('clientModalLabel').textContent = 'Add New Client';
    document.getElementById('clientForm').reset();
    document.getElementById('editClientCode').value = '';
    editingClientCode = null;
    new bootstrap.Modal(document.getElementById('clientModal')).show();
}

function editClient(clientCode) {
    fetch(`/api/clients`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const client = data.data.find(c => c.client_code === clientCode);
                if (client) {
                    document.getElementById('clientModalLabel').textContent = 'Edit Client';
                    document.getElementById('clientName').value = client.client_name;
                    document.getElementById('gstin').value = client.gstin;
                    document.getElementById('dateOfRegistration').value = client.date_of_registration;
                    document.getElementById('effectiveDateOfCancellation').value = client.effective_date_of_cancellation || '';
                    document.getElementById('taxpayerType').value = client.taxpayer_type;
                    document.getElementById('clientEmailId').value = client.client_email_id;
                    document.getElementById('mobileNo').value = client.mobile_no;
                    document.getElementById('gstPortalUserId').value = client.gst_portal_userid;
                    document.getElementById('gstPortalPassword').value = client.gst_portal_password;
                    document.getElementById('ewayBillUserId').value = client.eway_bill_userid || '';
                    document.getElementById('ewayBillPassword').value = client.eway_bill_password || '';
                    document.getElementById('emailPassword').value = client.email_password || '';
                    
                    document.getElementById('editClientCode').value = clientCode;
                    editingClientCode = clientCode;
                    new bootstrap.Modal(document.getElementById('clientModal')).show();
                }
            }
        });
}

function deleteClient(clientCode) {
    if (confirm('Are you sure you want to delete this client? This will also delete all associated return data.')) {
        fetch(`/api/clients/${clientCode}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Client deleted successfully!', 'success');
                location.reload();
            } else {
                showAlert('Error deleting client: ' + data.error, 'danger');
            }
        });
    }
}

function importClients() {
    new bootstrap.Modal(document.getElementById('importModal')).show();
}

function exportClients() {
    window.location.href = '/api/export_clients';
}

function downloadTemplate() {
    window.location.href = '/api/download_template';
}

// Handle client form submission
document.getElementById('clientForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const clientData = Object.fromEntries(formData.entries());
    
    // Remove empty values
    Object.keys(clientData).forEach(key => {
        if (clientData[key] === '') {
            delete clientData[key];
        }
    });
    
    const url = editingClientCode ? `/api/clients/${editingClientCode}` : '/api/clients';
    const method = editingClientCode ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(clientData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('clientModal')).hide();
            location.reload();
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    });
});

// Handle import form submission
document.getElementById('importForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('importFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('Please select a file to import.', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/api/import_clients', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = `Successfully imported ${data.imported_count} clients.`;
            if (data.errors.length > 0) {
                message += `\n\nErrors encountered:\n${data.errors.join('\n')}`;
            }
            showAlert(message, data.errors.length > 0 ? 'warning' : 'success');
            bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
            location.reload();
        } else {
            showAlert('Error importing clients: ' + data.error, 'danger');
        }
    });
});

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.insertBefore(alertDiv, document.body.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}
